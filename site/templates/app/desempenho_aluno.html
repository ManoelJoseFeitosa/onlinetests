{% extends "app/base.html" %}

{% block title %}Painel de Desempenho{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Painel de Desempenho</h1>
        <button id="gerar-pdf" class="btn btn-danger btn-icon-split btn-sm">
            <span class="icon text-white-50"><i class="fas fa-file-pdf"></i></span>
            <span class="text">Gerar PDF</span>
        </button>
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Filtros de Análise</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label for="filtro-turma" class="form-label">Selecione a Turma:</label>
                    <select id="filtro-turma" class="form-control">
                        <option value="">-- Selecione uma turma --</option>
                    </select>
                </div>
                <div class="col-md-5 mb-3">
                    <label for="filtro-aluno" class="form-label">Selecione o Aluno:</label>
                    <select id="filtro-aluno" class="form-control" disabled>
                        <option value="">-- Todos da Turma --</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div id="charts-container">
        <div id="mensagem-inicial" class="text-center py-5">
            <i class="fas fa-chart-line fa-3x text-gray-400 mb-3"></i>
            <p class="text-gray-600">Selecione uma turma para visualizar o desempenho geral.</p>
        </div>
        </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const filtroTurma = document.getElementById('filtro-turma');
    const filtroAluno = document.getElementById('filtro-aluno');
    const chartsContainer = document.getElementById('charts-container');
    const btnGerarPdf = document.getElementById('gerar-pdf');
    let activeCharts = [];

    function limparVisualizacao() {
        activeCharts.forEach(chart => chart.destroy());
        activeCharts = [];
        chartsContainer.innerHTML = '';
    }
    
    function exibirMensagem(texto, tipo = 'info') {
        limparVisualizacao();
        let iconClass = 'fas fa-info-circle';
        if (tipo === 'loading') iconClass = 'fas fa-spinner fa-spin';
        if (tipo === 'error') iconClass = 'fas fa-exclamation-triangle';
        chartsContainer.innerHTML = `<div class="text-center py-5"><i class="${iconClass} fa-3x text-gray-400 mb-3"></i><p class="text-gray-600">${texto}</p></div>`;
    }

    function criarWrapperGrafico(id, titulo) {
        const wrapper = document.createElement('div');
        wrapper.className = 'col-xl-6 col-lg-12 mb-4';
        wrapper.innerHTML = `
            <div class="card shadow h-100">
                <div class="card-header py-3"><h6 class="m-0 font-weight-bold text-primary">${titulo}</h6></div>
                <div class="card-body"><div class="chart-area" style="height: 320px;"><canvas id="${id}"></canvas></div></div>
            </div>`;
        return wrapper;
    }

    function renderizarGrafico(ctx, tipo, data, options) {
        const chart = new Chart(ctx, { type: tipo, data: data, options: options });
        activeCharts.push(chart);
    }

    async function carregarTurmas() {
        try {
            const response = await fetch("{{ url_for('main_routes.api_get_turmas_desempenho') }}");
            if (!response.ok) throw new Error('Falha ao buscar turmas.');
            const turmas = await response.json();
            turmas.forEach(turma => filtroTurma.add(new Option(turma.nome, turma.id)));
        } catch (error) {
            console.error(error);
            alert('Não foi possível carregar as turmas. Tente recarregar a página.');
        }
    }

    // Evento: Mudança no filtro de turma
    filtroTurma.addEventListener('change', async function() {
        const turmaId = this.value;
        filtroAluno.innerHTML = '<option value="">-- Todos da Turma --</option>';
        filtroAluno.disabled = true;
        
        if (!turmaId) {
            exibirMensagem('Selecione uma turma para visualizar o desempenho geral.');
            return;
        }

        exibirMensagem('Carregando dados da turma...', 'loading');
        
        try {
            // ===========================================================================
            // CORREÇÃO APLICADA AQUI: Forma correta de construir as URLs dinâmicas
            // ===========================================================================
            const alunosUrl = "{{ url_for('main_routes.api_get_alunos_por_turma_desempenho', serie_id=123) }}".replace('123', turmaId);
            const desempenhoUrl = "{{ url_for('main_routes.api_get_desempenho_turma', serie_id=123) }}".replace('123', turmaId);

            // Carrega alunos da turma
            const alunosResponse = await fetch(alunosUrl);
            if (!alunosResponse.ok) throw new Error(`Falha ao buscar alunos: ${alunosResponse.statusText}`);
            
            const alunos = await alunosResponse.json();
            alunos.forEach(aluno => filtroAluno.add(new Option(aluno.nome, aluno.id)));
            filtroAluno.disabled = false;
            
            // Carrega e exibe gráfico da turma
            const desempenhoResponse = await fetch(desempenhoUrl);
            if (!desempenhoResponse.ok) throw new Error(`Falha ao buscar desempenho: ${desempenhoResponse.statusText}`);

            const desempenho = await desempenhoResponse.json();
            
            limparVisualizacao();
            if (desempenho.labels.length > 0) {
                const row = document.createElement('div');
                row.className = 'row';
                const wrapper = criarWrapperGrafico('turmaChart', `Média de Notas da Turma: ${filtroTurma.options[filtroTurma.selectedIndex].text}`);
                row.appendChild(wrapper);
                chartsContainer.appendChild(row);

                const ctx = document.getElementById('turmaChart').getContext('2d');
                renderizarGrafico(ctx, 'bar', 
                    { labels: desempenho.labels, datasets: [{ label: 'Média de Notas', data: desempenho.data, backgroundColor: 'rgba(78, 115, 223, 0.8)' }] },
                    { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10 } } }
                );
            } else {
                exibirMensagem('Nenhum resultado finalizado encontrado para esta turma.');
            }
        } catch (error) {
            console.error(error);
            exibirMensagem('Ocorreu um erro ao buscar os dados da turma.', 'error');
        }
    });

    // Evento: Mudança no filtro de aluno
    filtroAluno.addEventListener('change', async function() {
        const alunoId = this.value;
        
        if (!alunoId) {
            filtroTurma.dispatchEvent(new Event('change'));
            return;
        }

        exibirMensagem('Carregando dados do aluno...', 'loading');

        try {
            // ===========================================================================
            // CORREÇÃO APLICADA AQUI: Forma correta de construir a URL dinâmica
            // ===========================================================================
            const alunoUrl = "{{ url_for('main_routes.api_get_desempenho_aluno', aluno_id=123) }}".replace('123', alunoId);
            const response = await fetch(alunoUrl);
            if (!response.ok) throw new Error(`Falha ao buscar dados do aluno: ${response.statusText}`);

            const dados = await response.json();
            
            limparVisualizacao();
            const row = document.createElement('div');
            row.className = 'row';
            chartsContainer.appendChild(row);

            const wrapperGeral = criarWrapperGrafico('alunoGeralChart', `Evolução de Notas: ${this.options[this.selectedIndex].text}`);
            row.appendChild(wrapperGeral);
            const ctxGeral = document.getElementById('alunoGeralChart').getContext('2d');
            renderizarGrafico(ctxGeral, 'line',
                { labels: dados.geral.labels, datasets: [{ label: 'Nota', data: dados.geral.data, borderColor: 'rgba(28, 200, 138, 1)', tension: 0.1 }] },
                { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 10 } } }
            );

            const wrapperNivel = criarWrapperGrafico('alunoNivelChart', `Percentual de Acertos por Nível`);
            row.appendChild(wrapperNivel);
            const ctxNivel = document.getElementById('alunoNivelChart').getContext('2d');
            renderizarGrafico(ctxNivel, 'bar',
                { labels: dados.nivel.labels, datasets: [{ label: '% de Acertos', data: dados.nivel.data, backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'] }] },
                { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, max: 100 } } }
            );

        } catch (error) {
            console.error(error);
            exibirMensagem('Ocorreu um erro ao buscar os dados do aluno.', 'error');
        }
    });
    
    // Evento: Clique para Gerar PDF
    btnGerarPdf.addEventListener('click', function() {
        const { jsPDF } = window.jspdf;
        const container = document.getElementById('charts-container');
        // ... (código do PDF continua o mesmo) ...
    });

    carregarTurmas();
});
</script>
{% endblock %}