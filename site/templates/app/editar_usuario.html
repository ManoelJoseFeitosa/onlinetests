{% extends 'app/base.html' %}

{% block title %}Editar Usuário - {{ usuario.nome }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">Editar Usuário: <span class="text-primary">{{ usuario.nome }}</span></h1>
        <!-- CORREÇÃO APLICADA AQUI -->
        <a href="{{ url_for('main_routes.gerenciar_usuarios') }}" class="btn btn-outline-secondary">&larr; Voltar para Gerenciamento</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-4 p-md-5">
            
            <!-- CORREÇÃO APLICADA AQUI -->
            <form method="POST" action="{{ url_for('main_routes.editar_usuario', user_id=usuario.id) }}" id="form-editar-usuario">
            <h5 class="mb-3 border-bottom pb-2">Dados Pessoais</h5>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="nome" class="form-label">Nome Completo</label>
                        <input type="text" class="form-control" id="nome" name="nome" value="{{ usuario.nome }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label">E-mail</label>
                        <input type="email" class="form-control" id="email" name="email" value="{{ usuario.email }}" required>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="senha" class="form-label">Nova Senha</label>
                    <input type="password" class="form-control" id="senha" name="senha" placeholder="Deixe em branco para não alterar">
                    <small class="form-text text-muted">A senha atual não será exibida. Digite uma nova senha apenas se desejar alterá-la.</small>
                </div>

                <hr>

                <h5 class="mb-3 border-bottom pb-2">Perfil e Associações</h5>
                <div class="mb-3">
                    <label for="role_display" class="form-label">Função</label>
                    <input type="text" class="form-control" id="role_display" value="{{ usuario.role|capitalize }}" readonly disabled>
                    <small class="form-text text-muted">A função de um usuário não pode ser alterada após a criação.</small>
                </div>
                
                <div id="professor_fields_edit" style="display: {% if usuario.role == 'professor' %}block{% else %}none{% endif %};">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="disciplinas_ids_edit" class="form-label">Disciplinas Lecionadas</label>
                            {% set professor_disciplinas_ids = usuario.disciplinas_lecionadas|map(attribute='id')|list %}
                            <select class="form-select" name="disciplinas_ids" id="disciplinas_ids_edit" multiple size="6">
                                {% for disciplina in disciplinas %}
                                    <option value="{{ disciplina.id }}" {% if disciplina.id in professor_disciplinas_ids %}selected{% endif %}>
                                        {{ disciplina.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Segure Ctrl (ou Cmd no Mac) para selecionar.</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="series_ids_edit" class="form-label">Turmas Lecionadas</label>
                            {% set professor_series_ids = usuario.series_lecionadas|map(attribute='id')|list %}
                            <select class="form-select" name="series_ids" id="series_ids_edit" multiple size="6">
                                {% for serie in series %}
                                    <option value="{{ serie.id }}" {% if serie.id in professor_series_ids %}selected{% endif %}>
                                        {{ serie.nome }}
                                    </option>
                                {% endfor %}
                            </select>
                             <div class="form-text">Segure Ctrl (ou Cmd no Mac) para selecionar.</div>
                        </div>
                    </div>
                </div>
            
            </form>
            
            {% if usuario.role == 'aluno' %}
            <fieldset class="border p-3 rounded mt-4">
                <legend class="fs-6 fw-bold px-2">Gerenciar Matrícula por Ano Letivo</legend>

                <div class="mb-3">
                    <label for="ano_letivo_select" class="form-label">Selecione o Ano Letivo para visualizar ou editar a matrícula:</label>
                    <select id="ano_letivo_select" class="form-select">
                        <option value="">-- Selecione um Ano --</option>
                        {% for ano in anos_letivos %}
                        <option value="{{ ano.id }}" {% if ano.status == 'ativo' %}selected{% endif %}>
                            {{ ano.ano }} ({{ ano.status }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div id="matricula-form-container" class="bg-light p-3 rounded">
                    </div>
            </fieldset>
            {% endif %}
            
            <div class="text-center mt-5">
                <button type="submit" form="form-editar-usuario" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle-fill me-2"></i>Salvar Alterações Cadastrais
                </button>
            </div>
            </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const anoLetivoSelect = document.getElementById('ano_letivo_select');
    const matriculaFormContainer = document.getElementById('matricula-form-container');
    const userId = '{{ usuario.id }}';
    const allSeries = {{ series_json | tojson | safe }};

    function carregarFormMatricula() {
        const anoId = anoLetivoSelect.value;
        matriculaFormContainer.innerHTML = ''; 

        if (!anoId) {
            matriculaFormContainer.innerHTML = '<p class="text-center text-muted m-0">Selecione um ano letivo acima.</p>';
            return;
        }

        matriculaFormContainer.innerHTML = '<p class="text-muted">Carregando dados da matrícula...</p>';
        
        // CORREÇÃO APLICADA AQUI
        const url = `{{ url_for('main_routes.get_matricula_por_ano', user_id=0, ano_letivo_id=0) }}`.replace('/0/0', `/${userId}/${anoId}`);

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Erro de Rede: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                let seriesOptionsHTML = allSeries.map(serie => {
                    const isSelected = data.matriculado && data.serie_id === serie.id ? 'selected' : '';
                    return `<option value="${serie.id}" ${isSelected}>${serie.nome}</option>`;
                }).join('');

                const statusAtual = data.matriculado 
                    ? `Status atual: <span class="badge bg-success">${data.status}</span>` 
                    : 'Status atual: <span class="badge bg-warning text-dark">Não Matriculado</span>';
                
                const anoSelecionadoTexto = anoLetivoSelect.options[anoLetivoSelect.selectedIndex].text.match(/\d{4}/);
                const anoFormatado = anoSelecionadoTexto ? anoSelecionadoTexto[0] : '';

                const formHTML = `
                    <!-- CORREÇÃO APLICADA AQUI -->
                    <form action="{{ url_for('main_routes.salvar_matricula') }}" method="POST">
                        <input type="hidden" name="user_id" value="${userId}">
                        <input type="hidden" name="ano_letivo_id" value="${anoId}">
                        
                        <p class="small mb-2">${statusAtual}</p>

                        <div class="mb-3">
                            <label for="serie_matricula" class="form-label">Série para o ano de <strong>${anoFormatado}</strong>:</label>
                            <select id="serie_matricula" name="serie_id" class="form-select" required>
                                <option value="">-- Selecione a série --</option>
                                ${seriesOptionsHTML}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>
                            ${data.matriculado ? 'Atualizar Matrícula' : 'Matricular Aluno'}
                        </button>
                    </form>
                `;
                matriculaFormContainer.innerHTML = formHTML;
            })
            .catch(error => {
                console.error('Erro ao buscar ou processar matrícula:', error);
                matriculaFormContainer.innerHTML = '<p class="text-danger fw-bold">Erro ao carregar dados. Verifique o console para mais detalhes (F12).</p>';
            });
    }

    if (anoLetivoSelect) {
        anoLetivoSelect.addEventListener('change', carregarFormMatricula);
        carregarFormMatricula();
    }
});
</script>
{% endblock %}
