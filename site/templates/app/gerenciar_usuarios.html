{% extends 'app/base.html' %}

{% block title %}
    Gerenciar Usu√°rios
{% endblock %}

{% block content %}
<div class="container mt-5">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="display-6">Gerenciamento de Usu√°rios üßë‚Äçüè´</h1>
            <p class="lead mb-0">Cadastre novos usu√°rios no sistema ou edite os existentes na lista abaixo.</p>
        </div>
        <div>
            <a href="{{ url_for('main_routes.dashboard') }}" class="btn btn-outline-secondary">
                &larr; Voltar ao Painel
            </a>
        </div>
    </div>
    <hr class="mb-5">

    <div class="row g-5 justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-person-plus-fill me-2"></i>Cadastrar Novo Usu√°rio</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label for="nome" class="form-label">Nome Completo</label>
                                <input type="text" class="form-control" id="nome" name="nome" required>
                            </div>

                            <!-- ### CORRE√á√ÉO APLICADA AQUI: Campo de senha adicionado ### -->
                            <div class="col-md-6">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="col-md-6">
                                <label for="senha" class="form-label">Senha Provis√≥ria</label>
                                <input type="text" class="form-control" id="senha" name="senha" required placeholder="Defina uma senha inicial">
                            </div>
                            <!-- ### FIM DA CORRE√á√ÉO ### -->

                            <div class="col-md-12">
                                <label for="role" class="form-label">Perfil do Usu√°rio</label>
                                <select class="form-select" id="role" name="role" required>
                                    <option selected disabled value="">Selecione um perfil...</option>
                                    <option value="aluno">Aluno</option>
                                    <option value="professor">Professor</option>
                                    <option value="coordenador">Coordenador</option>
                                </select>
                            </div>

                            <div class="col-md-12" id="campo_serie" style="display: none;">
                                <label for="serie_id" class="form-label">S√©rie</label>
                                <select class="form-select" id="serie_id" name="serie_id">
                                    <option value="">Selecione a s√©rie do aluno...</option>
                                    {% for serie in series %}
                                    <option value="{{ serie.id }}">{{ serie.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-12" id="campo_disciplinas" style="display: none;">
                                <label for="disciplinas_ids" class="form-label">Disciplinas Lecionadas</label>
                                <select class="form-select" id="disciplinas_ids" name="disciplinas_ids" multiple size="4">
                                    {% for disciplina in disciplinas %}
                                    <option value="{{ disciplina.id }}">{{ disciplina.nome }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Segure Ctrl (ou Cmd no Mac) para selecionar m√∫ltiplas disciplinas.</div>
                            </div>
                            <div class="col-md-12" id="campo_series_professor" style="display: none;">
                                <label for="series_ids" class="form-label">Turmas Lecionadas</label>
                                <select class="form-select" id="series_ids" name="series_ids" multiple size="4">
                                    {% for serie in series %}
                                    <option value="{{ serie.id }}">{{ serie.nome }}</option>
                                    {% endfor %}
                                </select>
                                <div class="form-text">Segure Ctrl (ou Cmd no Mac) para selecionar m√∫ltiplas turmas.</div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                           <i class="bi bi-check-circle-fill me-2"></i>Criar Usu√°rio
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <hr class="my-5">
    <h2 class="display-6 mb-4"><i class="bi bi-people-fill me-2"></i>Usu√°rios Cadastrados</h2>

    <ul class="nav nav-tabs nav-fill mb-3" id="userTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="alunos-tab" data-bs-toggle="tab" data-bs-target="#alunos-pane" type="button" role="tab" aria-controls="alunos-pane" aria-selected="true">
                <i class="bi bi-backpack-fill me-1"></i> Alunos
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="professores-tab" data-bs-toggle="tab" data-bs-target="#professores-pane" type="button" role="tab" aria-controls="professores-pane" aria-selected="false">
                <i class="bi bi-person-video3 me-1"></i> Professores
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="coordenadores-tab" data-bs-toggle="tab" data-bs-target="#coordenadores-pane" type="button" role="tab" aria-controls="coordenadores-pane" aria-selected="false">
                <i class="bi bi-person-workspace me-1"></i> Coordenadores
            </button>
        </li>
    </ul>

    <div class="tab-content" id="userTabContent">
        
        <div class="tab-pane fade show active" id="alunos-pane" role="tabpanel" aria-labelledby="alunos-tab" tabindex="0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th class="text-center">Perfil</th>
                            <th>S√©rie Atual</th>
                            <th class="text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set found = namespace(value=false) %}
                        {% for usuario in usuarios %}
                            {% if usuario.role == 'aluno' %}
                                {% set found.value = true %}
                                <tr>
                                    <td>{{ usuario.nome }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td class="text-center"><span class="badge bg-secondary">{{ usuario.role|capitalize }}</span></td>
                                    <td>{{ usuario.serie_atual.nome if usuario.serie_atual else '<span class="text-danger small">Sem matr√≠cula ativa</span>'|safe }}</td>
                                    <td class="text-center">
                                        <a href="{{ url_for('main_routes.editar_usuario', user_id=usuario.id) }}" class="btn btn-sm btn-outline-primary" title="Editar {{ usuario.nome }}"><i class="bi bi-pencil-fill"></i> Editar</a>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        {% if not found.value %}
                            <tr><td colspan="5" class="text-center text-muted py-4">Nenhum aluno cadastrado.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="tab-pane fade" id="professores-pane" role="tabpanel" aria-labelledby="professores-tab" tabindex="0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th class="text-center">Perfil</th>
                            <th>Turmas Lecionadas</th>
                            <th class="text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set found = namespace(value=false) %}
                        {% for usuario in usuarios %}
                            {% if usuario.role == 'professor' %}
                                {% set found.value = true %}
                                <tr>
                                    <td>{{ usuario.nome }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td class="text-center"><span class="badge bg-info text-dark">{{ usuario.role|capitalize }}</span></td>
                                    <td>
                                        {% if usuario.series_lecionadas %}
                                            {% for serie in usuario.series_lecionadas %}
                                                <span class="badge bg-secondary fw-normal me-1">{{ serie.nome }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted small">Nenhuma turma associada</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <a href="{{ url_for('main_routes.editar_usuario', user_id=usuario.id) }}" class="btn btn-sm btn-outline-primary" title="Editar {{ usuario.nome }}"><i class="bi bi-pencil-fill"></i> Editar</a>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        {% if not found.value %}
                            <tr><td colspan="5" class="text-center text-muted py-4">Nenhum professor cadastrado.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="tab-pane fade" id="coordenadores-pane" role="tabpanel" aria-labelledby="coordenadores-tab" tabindex="0">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th class="text-center">Perfil</th>
                            <th class="text-center">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set found = namespace(value=false) %}
                        {% for usuario in usuarios %}
                            {% if usuario.role == 'coordenador' %}
                                {% set found.value = true %}
                                <tr>
                                    <td>{{ usuario.nome }}</td>
                                    <td>{{ usuario.email }}</td>
                                    <td class="text-center"><span class="badge bg-primary">{{ usuario.role|capitalize }}</span></td>
                                    <td class="text-center">
                                        <a href="{{ url_for('main_routes.editar_usuario', user_id=usuario.id) }}" class="btn btn-sm btn-outline-primary" title="Editar {{ usuario.nome }}"><i class="bi bi-pencil-fill"></i> Editar</a>
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                        {% if not found.value %}
                            <tr><td colspan="4" class="text-center text-muted py-4">Nenhum coordenador cadastrado.</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Script para os campos din√¢micos do formul√°rio de cadastro
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('role');
    const campoSerie = document.getElementById('campo_serie');
    const campoDisciplinas = document.getElementById('campo_disciplinas');
    const selectSerie = document.getElementById('serie_id');
    const campoSeriesProfessor = document.getElementById('campo_series_professor');

    function toggleFields() {
        campoSerie.style.display = 'none';
        campoDisciplinas.style.display = 'none';
        campoSeriesProfessor.style.display = 'none';
        selectSerie.required = false;

        if (roleSelect.value === 'aluno') {
            campoSerie.style.display = 'block';
            selectSerie.required = true;
        } else if (roleSelect.value === 'professor') {
            campoDisciplinas.style.display = 'block';
            campoSeriesProfessor.style.display = 'block';
        }
    }

    if (roleSelect) {
        roleSelect.addEventListener('change', toggleFields);
        toggleFields();
    }
});
</script>

{% endblock %}
