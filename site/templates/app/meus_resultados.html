{% extends 'app/base.html' %}

{% block title %}Meu Desempenho{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">Meu Desempenho üöÄ</h1>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">&larr; Voltar ao Painel</a>
    </div>

    <ul class="nav nav-tabs" id="desempenhoTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="provas-tab" data-bs-toggle="tab" data-bs-target="#provas-pane" type="button" role="tab" aria-controls="provas-pane" aria-selected="true">
                <i class="bi bi-journal-text me-2"></i>Provas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="simulados-tab" data-bs-toggle="tab" data-bs-target="#simulados-pane" type="button" role="tab" aria-controls="simulados-pane" aria-selected="false">
                <i class="bi bi-grid-1x2-fill me-2"></i>Simulados
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="disciplinas-tab" data-bs-toggle="tab" data-bs-target="#disciplinas-pane" type="button" role="tab" aria-controls="disciplinas-pane" aria-selected="false">
                <i class="bi bi-pie-chart-fill me-2"></i>Desempenho por Disciplina
            </button>
        </li>
    </ul>

    <div class="tab-content" id="desempenhoTabContent">
        
        <div class="tab-pane fade show active" id="provas-pane" role="tabpanel" aria-labelledby="provas-tab" tabindex="0">
            <div class="p-4 bg-light border border-top-0 rounded-bottom">
                {% if total_provas > 0 %}
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card text-center text-white bg-primary h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">M√©dia Geral (Provas)</h5>
                                <p class="display-4 fw-bold mb-0">{{ media_provas }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card text-center h-100">
                             <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">Provas Conclu√≠das</h5>
                                <p class="display-4 fw-bold mb-0">{{ total_provas }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 d-none d-lg-block"></div>

                    <div class="col-12 mt-4">
                        <div class="card">
                            <div class="card-header fw-bold">Evolu√ß√£o das Notas por Disciplina</div>
                            <div class="card-body">
                                <canvas id="graficoProvasPorDisciplina"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info text-center">Voc√™ ainda n√£o concluiu nenhuma prova.</div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="simulados-pane" role="tabpanel" aria-labelledby="simulados-tab" tabindex="0">
            <div class="p-4 bg-light border border-top-0 rounded-bottom">
                 {% if total_simulados > 0 %}
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card text-center text-white bg-success h-100">
                            <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">M√©dia Geral (Simulados)</h5>
                                <p class="display-4 fw-bold mb-0">{{ media_simulados }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card text-center h-100">
                              <div class="card-body d-flex flex-column justify-content-center">
                                <h5 class="card-title">Simulados Conclu√≠dos</h5>
                                <p class="display-4 fw-bold mb-0">{{ total_simulados }}</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 mt-4">
                        <div class="card">
                            <div class="card-header fw-bold">Evolu√ß√£o das Notas (Simulados)</div>
                            <div class="card-body">
                                <canvas id="graficoSimulados"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                 {% else %}
                <div class="alert alert-info text-center">Voc√™ ainda n√£o concluiu nenhum simulado.</div>
                {% endif %}
            </div>
        </div>

        <div class="tab-pane fade" id="disciplinas-pane" role="tabpanel" aria-labelledby="disciplinas-tab" tabindex="0">
             <div class="p-4 bg-light border border-top-0 rounded-bottom">
                 <div class="accordion" id="accordionDisciplinas">
                     {% for nome_disciplina, dados in dados_por_disciplina.items() %}
                     <div class="accordion-item">
                         <h2 class="accordion-header" id="heading_{{ nome_disciplina|replace(' ', '') }}">
                             <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse_{{ nome_disciplina|replace(' ', '') }}" aria-expanded="false" aria-controls="collapse_{{ nome_disciplina|replace(' ', '') }}">
                                 <div class="d-flex justify-content-between w-100 align-items-center pe-3">
                                     <span class="fw-bold fs-5">{{ nome_disciplina }}</span>
                                     <span class="badge bg-dark rounded-pill">M√©dia: {{ "%.1f"|format(dados.media) }}</span>
                                 </div>
                             </button>
                         </h2>
                         <div id="collapse_{{ nome_disciplina|replace(' ', '') }}" class="accordion-collapse collapse" data-bs-parent="#accordionDisciplinas">
                             <div class="accordion-body p-0">
                                 <ul class="list-group list-group-flush">
                                     {% for avaliacao in dados.avaliacoes %}
                                     <a href="{{ url_for('ver_resultado_detalhado', resultado_id=avaliacao.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                         <div>
                                             {{ avaliacao.nome }}
                                             <small class="d-block text-muted">{{ avaliacao.data }}</small>
                                         </div>
                                         <span class="badge bg-primary rounded-pill fs-6">Nota: {{ "%.1f"|format(avaliacao.nota) }}</span>
                                     </a>
                                     {% endfor %}
                                 </ul>
                             </div>
                         </div>
                     </div>
                     {% else %}
                     <div class="alert alert-info text-center">Nenhum dado de desempenho por disciplina para exibir.</div>
                     {% endfor %}
                 </div>
             </div>
        </div>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- NOVO GR√ÅFICO DE PROVAS POR DISCIPLINA ---
    try {
        const chartDataProvas = JSON.parse('{{ chart_data_provas_por_disciplina_json | safe }}');
        const canvasProvas = document.getElementById('graficoProvasPorDisciplina');

        if (canvasProvas && chartDataProvas && chartDataProvas.datasets && chartDataProvas.datasets.length > 0) {
            new Chart(canvasProvas.getContext('2d'), {
                type: 'line',
                data: chartDataProvas, // Usa diretamente a estrutura de dados do backend
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: false }, // O t√≠tulo j√° est√° no card-header
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            title: { display: true, text: 'Nota' }
                        },
                        x: {
                            title: { display: true, text: 'Data da Avalia√ß√£o' }
                        }
                    }
                }
            });
        } else if (canvasProvas) {
            const container = canvasProvas.parentElement;
            container.innerHTML = '<p class="text-center text-muted my-5">N√£o h√° dados suficientes para exibir a evolu√ß√£o das notas.</p>';
        }
    } catch (e) {
        console.error("Erro ao renderizar o gr√°fico de provas:", e);
    }

    // --- GR√ÅFICO DE SIMULADOS (L√ìGICA MANTIDA) ---
    const canvasSimulados = document.getElementById('graficoSimulados');
    if (canvasSimulados) {
        new Chart(canvasSimulados.getContext('2d'), {
            type: 'bar', // Mudado para 'bar' para diferenciar visualmente
            data: {
                labels: {{ chart_labels_simulados|tojson|safe }},
                datasets: [{
                    label: 'Nota do Simulado',
                    data: {{ chart_data_simulados|tojson|safe }},
                    backgroundColor: 'rgba(25, 135, 84, 0.6)',
                    borderColor: 'rgba(25, 135, 84, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: { beginAtZero: true, max: 10 }
                },
                responsive: true,
                maintainAspectRatio: false,
            }
        });
    }
});
</script>
{% endblock %}