{% extends 'app/base.html' %}

{% block title %}Responder: {{ avaliacao.nome }}{% endblock %}

{% block content %}
<style>
    /* Estilo para o cronômetro fixo no canto da tela */
    #timer-fixed-container {
        position: fixed;
        top: 80px; /* Distância do topo da página */
        right: 20px; /* Distância da direita */
        padding: 8px 15px;
        background-color: rgba(0, 0, 0, 0.7); /* Fundo escuro semitransparente */
        color: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 1050; /* Z-index alto para ficar sobre outros elementos */
        font-size: 1.25rem;
        font-weight: 500;
        transition: background-color 0.5s, color 0.5s;
    }

    /* Classe para quando o tempo estiver acabando */
    #timer-fixed-container.timer-alerta {
        background-color: #ffc107; /* Amarelo */
        color: #333;
        font-weight: bold;
    }
    #timer-fixed-container.timer-critico {
        background-color: #dc3545; /* Vermelho */
        color: white;
        font-weight: bold;
    }

    /* Estilo para a mensagem de flash customizada */
    #flash-message {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        background-color: #ffc107; /* Amarelo de alerta */
        color: #333;
        padding: 10px 20px;
        border-radius: 0 0 5px 5px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 2000;
        display: none; /* Começa escondido */
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.5s;
    }

    #flash-message.show {
        display: block;
        opacity: 1;
    }
    
    #flash-message.error {
        background-color: #dc3545; /* Vermelho para a mensagem final */
        color: white;
    }
</style>

<div id="flash-message"></div>

<div class="container-fluid mt-4">

    <div id="inicio-container" class="text-center p-5 border rounded-3 bg-light mx-auto" style="max-width: 800px;">
        <h1 class="display-5">{{ avaliacao.nome }}</h1>
        <p class="fs-5 text-muted">Disciplina: {{ avaliacao.disciplina.nome if avaliacao.disciplina else 'Simulado' }}</p>
        <hr>
        <div class="text-start my-4">
            <h4>Atenção: Regras da Avaliação</h4>
            
            <p class="mb-2"><strong><i class="bi bi-stopwatch"></i> Tempo Limite:</strong> 
                {% if avaliacao.tempo_limite and avaliacao.tempo_limite > 0 %}
                    {{ avaliacao.tempo_limite }} minutos.
                {% else %}
                    Ilimitado.
                {% endif %}
            </p>
            
            <p>Para garantir a lisura do processo, esta avaliação será realizada em <strong>modo de tela cheia</strong>. As seguintes regras se aplicam:</p>
            <ul>
                <li>Você <strong>NÃO</strong> poderá sair do modo de tela cheia durante a prova.</li>
                <li>Alternar para outras abas, usar atalhos como ALT+TAB ou pressionar a tecla ESC será considerado uma infração.</li>
            </ul>
            <p class="fw-bold text-danger">Qualquer tentativa de sair da tela resultará no BLOQUEIO IMEDIATO da prova. Após o bloqueio, você só poderá enviar as respostas já marcadas.</p>
        </div>
        <button type="button" class="btn btn-primary btn-lg" id="btn-iniciar-prova">Estou Ciente e Pronto para Iniciar</button>
    </div>

    <div id="conteudo-prova" style="display: none;">
        
        {% if avaliacao.tempo_limite and avaliacao.tempo_limite > 0 %}
            <div id="timer-fixed-container">
                <i class="bi bi-clock-history"></i>
                <span id="timer-display">--:--</span>
            </div>
        {% endif %}

        <div class="card shadow-sm">
            <div class="card-header bg-light py-3">
                <h2 class="card-title mb-0">{{ avaliacao.nome }}</h2>
            </div>
            <div class="card-body p-4 p-md-5">
                <!-- CORREÇÃO APLICADA AQUI -->
                <form id="form-responder-avaliacao" method="POST" action="{{ url_for('main_routes.responder_avaliacao', avaliacao_id=avaliacao.id) }}">
                    
                    <fieldset id="questoes-fieldset">
                        {% for questao in avaliacao.questoes %}
                            <div class="card mb-4">
                                <div class="card-header">
                                    <strong>Questão {{ loop.index }}: {{ questao.disciplina.nome }}</strong>
                                </div>
                                <div class="card-body">
                                    {% if questao.imagem_nome %}
                                    <div class="text-center mb-3">
                                        <img src="{{ url_for('static', filename='uploads/questoes/' + questao.imagem_nome) }}" 
                                             alt="{{ questao.imagem_alt or 'Imagem da questão ' ~ loop.index }}" 
                                             class="img-fluid rounded" 
                                             style="max-height: 400px; border: 1px solid #dee2e6;">
                                    </div>
                                    {% endif %}
                                    <div class="fs-5 mb-3">{{ questao.texto | safe }}</div>
                                    <hr>
                                    {% if questao.tipo == 'multipla_escolha' %}
                                        <div class="form-check"><input class="form-check-input" type="radio" name="resposta_{{ questao.id }}" id="q{{ questao.id }}a" value="A" required><label class="form-check-label" for="q{{ questao.id }}a">A) {{ questao.opcao_a }}</label></div>
                                        <div class="form-check"><input class="form-check-input" type="radio" name="resposta_{{ questao.id }}" id="q{{ questao.id }}b" value="B" required><label class="form-check-label" for="q{{ questao.id }}b">B) {{ questao.opcao_b }}</label></div>
                                        <div class="form-check"><input class="form-check-input" type="radio" name="resposta_{{ questao.id }}" id="q{{ questao.id }}c" value="C" required><label class="form-check-label" for="q{{ questao.id }}c">C) {{ questao.opcao_c }}</label></div>
                                        <div class="form-check"><input class="form-check-input" type="radio" name="resposta_{{ questao.id }}" id="q{{ questao.id }}d" value="D" required><label class="form-check-label" for="q{{ questao.id }}d">D) {{ questao.opcao_d }}</label></div>
                                    {% elif questao.tipo == 'verdadeiro_falso' %}
                                        <div class="form-check"><input class="form-check-input" type="radio" name="resposta_{{ questao.id }}" id="q{{ questao.id }}a" value="A" required><label class="form-check-label" for="q{{ questao.id }}a">Verdadeiro</label></div>
                                        <div class="form-check"><input class="form-check-input" type="radio" name="resposta_{{ questao.id }}" id="q{{ questao.id }}b" value="B" required><label class="form-check-label" for="q{{ questao.id }}b">Falso</label></div>
                                    {% elif questao.tipo == 'discursiva' %}
                                        <textarea name="resposta_{{ questao.id }}" class="form-control" rows="5" placeholder="Digite sua resposta aqui..." required></textarea>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </fieldset> 
                    <div class="d-grid gap-2 mt-5">
                        <button type="submit" id="btn-enviar-avaliacao" class="btn btn-success btn-lg">
                            <i class="bi bi-check2-circle me-2"></i>Enviar Avaliação
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- ELEMENTOS DO DOM ---
    const inicioContainer = document.getElementById('inicio-container');
    const conteudoProva = document.getElementById('conteudo-prova');
    const formProva = document.getElementById('form-responder-avaliacao');
    const btnIniciarProva = document.getElementById('btn-iniciar-prova');
    const flashMessage = document.getElementById('flash-message');
    const timerDisplay = document.getElementById('timer-display');
    const timerContainer = document.getElementById('timer-fixed-container');
    const questoesFieldset = document.getElementById('questoes-fieldset');

    // --- VARIÁVEIS DE ESTADO ---
    let isProvaIniciada = false;
    let isSubmitting = false;
    let isBlocked = false;

    // --- FUNÇÕES AUXILIARES ---
    function showFlashMessage(message, type = 'warning', duration = 4000) {
        flashMessage.textContent = message;
        flashMessage.className = type === 'error' ? 'error' : '';
        flashMessage.classList.add('show');
        if (duration > 0) {
            setTimeout(() => flashMessage.classList.remove('show'), duration);
        }
    }

    function bloquearProva(motivo) {
        if (isBlocked) return;
        isBlocked = true;
        console.warn(`PROVA BLOQUEADA. Motivo: ${motivo}`);
        showFlashMessage(`PROVA BLOQUEADA: ${motivo}. Envie suas respostas agora.`, 'error', 0);
        questoesFieldset.disabled = true;
        document.removeEventListener('fullscreenchange', onFullscreenChange);
        document.removeEventListener('visibilitychange', onVisibilityChange);
        document.removeEventListener('keydown', onKeyDown);
    }

    // --- FUNÇÕES DE LÓGICA PRINCIPAL ---
    function iniciarCronometro(minutos) {
        if (!minutos || minutos <= 0) return;
        let tempoTotalSegundos = minutos * 60;
        const countdown = setInterval(function() {
            if (isSubmitting || isBlocked) {
                clearInterval(countdown);
                return;
            }
            if (tempoTotalSegundos <= 0) {
                clearInterval(countdown);
                bloquearProva('Tempo esgotado');
                formProva.submit();
            } else {
                tempoTotalSegundos--;
                const mins = Math.floor(tempoTotalSegundos / 60);
                const secs = tempoTotalSegundos % 60;
                timerDisplay.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                if (tempoTotalSegundos <= 60) {
                    timerContainer.className = 'timer-critico';
                } else if (tempoTotalSegundos <= 300) {
                    timerContainer.className = 'timer-alerta';
                }
            }
        }, 1000);
    }
    
    function onFullscreenChange() {
        if (!document.fullscreenElement) {
            bloquearProva("Saída da tela cheia");
        }
    }
    function onVisibilityChange() {
        if (document.hidden) {
            bloquearProva("Troca de aba/aplicativo");
        }
    }
    function onKeyDown(event) {
        if (event.key === 'Escape' || event.altKey) {
            event.preventDefault();
            bloquearProva(`Uso de tecla de atalho (${event.key})`);
        }
    }

    function ativarMonitoramento() {
        document.addEventListener('fullscreenchange', onFullscreenChange);
        document.addEventListener('visibilitychange', onVisibilityChange);
        document.addEventListener('keydown', onKeyDown);
        window.addEventListener('beforeunload', (event) => {
            if (isProvaIniciada && !isSubmitting) {
                event.preventDefault();
                event.returnValue = '';
            }
        });
    }

    // --- EVENT LISTENERS ---
    btnIniciarProva.addEventListener('click', function() {
        document.documentElement.requestFullscreen().then(() => {
            isProvaIniciada = true;
            inicioContainer.style.display = 'none';
            conteudoProva.style.display = 'block';
            ativarMonitoramento();
            iniciarCronometro({{ avaliacao.tempo_limite or 0 }});
        }).catch(err => {
            showFlashMessage('Erro: Não foi possível ativar o modo de tela cheia. Verifique as permissões do navegador.', 'error', 5000);
        });
    });

    formProva.addEventListener('submit', () => {
        isSubmitting = true;
    });
});
</script>
{% endblock %}
